`xbot`是一个基于企业微信的机器人。
它可以接收用户的命令并触发相应的服务，如查看服务器状态、重启服务器等。

**目的就是为了减轻个人的工作负担，提高工作效率。**

## 设计

本地提供一个HTTP服务，用于接收企业微信的消息推送。

对话遵循以下格式：

``[scene] [cmd] [args]``

其中，`scene` 是场景，`cmd` 是命令，`args` 是参数。

每个 ``scene`` 对应一个 Python 模块；而在模块中，cmd的处理函数命名为 ``cmd_`` + cmd。这样带来了方便：可以动态的添加命令。

为了更清晰地组织代码，你可以将不同的场景放在多个目录中，只要你在 `__init__.py` 文件中，将对应目录追加到 scene_dirs 即可。

框架会按照目录顺序进行搜索，如果有模块名冲突，优先使用排列靠前的模块。
比如，项目的初始创建了 services 和 activities 两个目录，用来存放不同服务和活动级别的场景模块。

有一个特殊的目录——``public``，用来存放不敏感的公用接口。

``common`` 目录则用来存放公共的函数和类。

---

服务上，独立消息处理和服务处理，消息处理负责解析消息，服务处理负责处理业务逻辑。

这样，可以快速的构建企业微信之外、别的即时通信工具对话的服务。

## 权限管理

因为企业微信能够获得用户ID，所以通过 scene + cmd + 日期的方式，对用户进行授权。

本地有 ``db.sqlite3``文件进行管理。TODO 提供个通过何种方式同步？

只有授权用户才能进行对话，否则提示错误。

## HELP 指令

- ``help``，列出所有的命令。
- ``help [scene]``，列出该场景下所有命令字。
- ``help [scene] [cmd]``，列出指定命令的详细帮助信息。

## Docker 部署

不使用流水线，直接推送Docker镜像，注意将仓库设置为私有。

构建：

```bash
docker build --network="host" -t jasonzxpan/xbot .
```

如果在当前目录运行，可以直接将目录映射到 /data/xbot：

```bash
docker run -i -v $PWD:/data/xbot -t jasonzxpan/xbot  /bin/bash``
```
